@page "/customer/profile"
@using BlazorWebAppCustomer.Services
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject AuthService AuthService
@inject NavigationManager NavManager

@inject ICustomerService CustomerService


<HeroSection Title="All Films" Subtitle="Browse our full collection of movies and discover your next favorite film." />

@if (isLoading)
{
    <p>Đang tải dữ liệu...</p>
}
else
{
    <!-- Thông tin tài khoản -->
    <div class="card mb-4 p-3">
        <h5>Thông tin tài khoản</h5>
        <p><b>Tài khoản:</b> @profile!.Username</p>
        <p><b>Ngày tạo:</b> @profile.CreatedDate.ToString()</p>
        
    </div>

    <!-- Hóa đơn -->
    <div class="mb-4">
        <h5>🧾 Hóa đơn của bạn</h5>

        @if (!invoices.Any())
        {
            <p class="text-muted">Chưa có hóa đơn nào</p>
        }
        else
        {
            @foreach (var invoice in invoices)
            {
                <div class="card mb-2 p-3">
                    <div class="d-flex justify-content-between">
                        <b>@invoice.InvoiceNumber</b>
                        <span>@invoice.InvoiceDate.ToString()</span>
                    </div>

                    <p>
                        Tổng tiền:
                        <b class="text-success">
                            @invoice.TotalAmount.ToString() $
                        </b>
                    </p>

                    <ul class="list-group">
                        @foreach (var d in invoice.InvoiceDetail)
                        {
                            <li class="list-group-item d-flex justify-content-between">
                                <span>



                                    <b>@(d.MovieTitle ?? d.PackageName)</b>
                                </span>
                                <span>
                                    @d.UnitPrice.ToString()$
                                </span>
                            </li>
                        }
                    </ul>
                </div>
            }
        }
    </div>

    <!-- Phim yêu thích -->
    <div>
        <h5>❤️ Phim đã thích</h5>

        @if (!favorites.Any())
        {
            <p class="text-muted">Bạn chưa thích phim nào</p>
        }
        else
        {
            <div class="row">
                @foreach (var f in favorites)
                {
                    <div class="col-md-3 mb-3">
                        <div class="card h-100 p-2 movie-card"
                             @onclick="() => GoToMovie(f.MovieId)">
                            <b>@f.MovieName</b>
                            <small class="text-muted">
                                Đã thêm: @f.AddedDate.ToString()
                            </small>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
}

@code {
    private CustomerViewModel? user;
    private string userName = "";


    private CustomerViewModel? profile;
    private List<InvoiceViewModel> invoices = new();
    private List<FavoriteMovieViewModel> favorites = new();
    private bool isLoading = true;


    protected override async Task OnInitializedAsync()
    {

        if (!await AuthService.IsAuthenticated())
        {
            NavManager.NavigateTo("/login", true);
        }

        await LoadData();


    }
    private async Task LoadData()
    {
        try
        {
            profile = await CustomerService.GetProfileAsync();
            invoices = await CustomerService.GetInvoicesAsync();
            favorites = await CustomerService.GetFavoritesAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    void GoToMovie(int? movieId)
    {
        NavManager.NavigateTo($"/movie/{movieId}");
    }

}
