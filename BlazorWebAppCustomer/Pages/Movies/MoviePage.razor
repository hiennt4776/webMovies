@page "/moviepage/{id:int}"
@using BlazorWebAppCustomer.Services
@using helperMovies.ViewModel
@using Microsoft.JSInterop
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IMovieService MovieService
@inject IFavoriteMovieService FavoriteMovieService
@inject IJSRuntime JS

@using System.Text.Json

<HeroSection Title="Create Account" Subtitle="Join Movie Hub and explore endless entertainment." />
@if (movie == null)
{
    <p>Loading...</p>
}
else
{
    <!-- Film Detail -->
    <section class="container my-5 pt-5">
        <div class="row glass-card p-4">
            <div class="col-md-4">
                <img id="filmPoster" src="@MovieService.GetMovieFileUrl(movie.Id, "poster")"  alt="Film Poster" class="img-fluid rounded shadow">
            </div>
            <div class="col-md-8">
                <h2 id="filmTitle">@movie.Title</h2>
                <p><strong>Genre:</strong> <span id="filmGenre">@movie.CategoryName</span></p>
                <p><strong>Release Date:</strong> <span id="filmRelease">@movie.ReleaseDate</span></p>
      
                <p id="filmDescription">
                    @movie.Description
                </p>
             
                @if (_access.IsFree)
                {
                    <p> <span class="badge bg-success ms-2">FREE</span>  </p>
                }
                @if (_access.CanWatch)
                {
                    <button class="btn btn-primary btn-toggle" @onclick="() => GoToWatch(movie.Id)">▶ Watch Film</button>
                }
                else
                {
                    <div class="alert alert-warning">
                        Phim trả phí – vui lòng mua hoặc thuê
                    </div>

                    @* 👉 MUA *@
                    @if (_access.ShowBuy)
                    {
                        <button class="btn btn-success" @onclick="() => BuyMovie(movie.Id)">🛒 Buy Film</button>
                    }

                    @* 👉 THUÊ *@
                    @if (_access.ShowRent)
                    {
                        <button class="btn btn-outline-warning"
                                @onclick="() => RentMovie(movie.Id)">
                            💳 Rent Film
                        </button>
                     
                    }
                }
                
                <button class="btn btn-outline-danger"
                        @onclick="ToggleFavorite">
                        @(IsFavorite ? "❤️ Add to favorites" : "🤍 Remove from favorites")
                </button>

             
            </div>
            @if (movie.HasTrailer)
            {
                <div class="col-12" style="margin-top:25px">
                    <video controls style="width:100%; height:auto;">
                        <source src="@MovieService.GetMovieFileUrl(movie.Id, "trailer")" type="video/mp4" />
                       The browser does not support video.
                    </video>
                </div>
            }
        </div>
    </section>
        
}

@code {
    [Parameter] public int id { get; set; }

    MovieViewModel? movie;

      private bool IsFavorite;
    private MovieAccessViewModel? _access;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        IsFavorite = await FavoriteMovieService.IsFavoriteAsync(id);
        try
        {
            _access = await MovieService.CheckAccessAsync(id);
        }
        finally
        {
            _loading = false;
        }
        movie = await MovieService.GetMovieAsync(id);
    }
    private async Task ToggleFavorite()
    {
        IsFavorite = await FavoriteMovieService.ToggleFavoriteAsync(id);
    }
    void GoToWatch(int movieId)
    {
        NavigationManager.NavigateTo($"/watch/{movieId}");
    }

    void RentMovie(int movieId)
    {
        NavigationManager.NavigateTo($"/movies/rent/{movieId}");
    }

    void BuyMovie(int movieId)
    {
        NavigationManager.NavigateTo($"/movies/buy/{movieId}");
    }
    string FormatPrice(decimal? price)
    {
        return price == null
            ? ""
            : string.Format("{0:N0} $", price);
    }


}
