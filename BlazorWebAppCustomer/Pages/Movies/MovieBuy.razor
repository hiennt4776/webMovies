@page "/movies/buy/{id:int}"
@using helperMovies.ViewModel
@using Microsoft.JSInterop
@using BlazorWebAppCustomer.Services
@inject IMoviePricingService MoviePricingService
@inject IInvoiceService InvoiceService
@inject IMovieService MovieService
@inject AuthService AuthService
@inject NavigationManager NavManager
@inject IJSRuntime JS

@if (BuyPrice == null)
{
    <p>Đang tải giá mua...</p>
}
else
{
@*     <h4>🛒 Mua phim</h4>

    <div class="card p-3">
        <div>
            <b>@BuyPrice.Price.ToString("N0") đ</b>
        </div>

        <button class="btn btn-success mt-2"
                @onclick="Buy">
            Mua ngay
        </button>
    </div> *@

    <section class="container my-5 pt-5">
        <div class="row glass-card p-4">
            <div class="col-md-4">
                <img id="filmPoster" src="@MovieService.GetMovieFileUrl(movie.Id, "poster")" alt="Film Poster" class="img-fluid rounded shadow">
            </div>
            <div class="col-md-8">
                <h2 id="filmTitle">@movie.Title</h2>
                <p><strong>Genre:</strong> <span id="filmGenre">@movie.CategoryName</span></p>
                <p><strong>Release Date:</strong> <span id="filmRelease">@movie.ReleaseDate</span></p>

                <p id="filmDescription">
                    @movie.Description
                </p>
                <p><b>@BuyPrice.Price.ToString("N0") $</b></p>

                <button class="btn btn-success mt-2"
                        @onclick="Buy">
                    Mua ngay
                </button>
            </div>
           
        </div>
    </section>
}

@code {
    [Parameter] public int id { get; set; }

    private MoviePricingViewModel? BuyPrice;
    MovieViewModel? movie;

    protected override async Task OnInitializedAsync()
    {
        if (!await AuthService.IsAuthenticated())
        {
            NavManager.NavigateTo("/login", true);
        }
        movie = await MovieService.GetMovieAsync(id);
        BuyPrice = await MoviePricingService.GetBuyPriceAsync(id);
    }

    private async Task Buy()
    {
        if (BuyPrice == null) return;

        var invoiceId = await InvoiceService.CreateInvoiceAsync(BuyPrice.Id);
        NavManager.NavigateTo($"/invoice/{invoiceId}");
    }
}
