@* @page "/login"
@using BlazorWebAppAdmin.Services
@inject NavigationManager Navigation
@inject IAuthService AuthService

<h3>Login</h3>

<EditForm Model="@loginModel" OnValidSubmit="@HandleLogin">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Username</label>
        <InputText class="form-control" @bind-Value="loginModel.Username" />
    </div>

    <div class="mb-3">
        <label>Password</label>
        <InputText class="form-control" type="password" @bind-Value="loginModel.Password" />
    </div>

    <button class="btn btn-primary" type="submit">Login</button>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="text-danger mt-2">@errorMessage</div>
    }
</EditForm>

@code {
    private LoginModel loginModel = new();
    private string? errorMessage;

    private async Task HandleLogin()
    {
        var success = await AuthService.LoginAsync(loginModel.Username, loginModel.Password);
        if (success)
        {
            Navigation.NavigateTo("/profile");
        }
        else
        {
            errorMessage = "Invalid username or password.";
        }
    }

    public class LoginModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}
 *@

@page "/login"
@using BlazorWebAppAdmin.Services
@using Microsoft.JSInterop
@inject IJSRuntime JS
@layout LoginLayout
@inject Blazored.LocalStorage.ILocalStorageService LocalStorageService
@inject IUserEmployeeService UserService
@inject NavigationManager NavigationManager

@using System.Text.Json
@using helperMovies.ViewModel




<div class="login-box">
    <div class="login-logo">
        <h3>Login Web Movies</h3>
    </div>
    <!-- /.login-logo -->
    <div class="card">
        <div class="card-body login-card-body">
            <p class="login-box-msg">Sign in to start</p>

            <EditForm Model="loginUserEmployeeViewModel" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="input-group mb-3">
                    <InputText class="form-control" @bind-Value="loginUserEmployeeViewModel.Username" placeholder="username" />
                    <div class="input-group-text"><span class="bi bi-person-fill"></span></div>
                    <ValidationMessage For="@(() => loginUserEmployeeViewModel.Username)" />
                </div>

                <div class="input-group mb-3">
                    <InputText type="password" class="form-control" @bind-Value="loginUserEmployeeViewModel.Password" placeholder="Password" />
                    <div class="input-group-text"><span class="bi bi-lock-fill"></span></div>
                    <ValidationMessage For="@(() => loginUserEmployeeViewModel.Password)" />
                </div>

                <!--begin::Row-->
                <div class="row">
                    <div class="col-8">
                        @if (!string.IsNullOrEmpty(message))
                        {
                            <p class="text-danger">@message</p>
                        }
                    </div>
                    <!-- /.col -->
                    <div class="col-4">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Sign In</button>
                        </div>
                    </div>
                    <!-- /.col -->
                </div>
                <!--end::Row-->
            </EditForm>


        </div>
        <!-- /.login-card-body -->
    </div>
</div>



@code {
    private LoginEmployeeRequestViewModel loginUserEmployeeViewModel = new LoginEmployeeRequestViewModel();
    private string message;
    private async Task HandleValidSubmit()
    {
        // Call UserService để login
        LoginEmployeeResponseViewModel loginEmployeeRequestViewModel = await UserService.LoginAsync(loginUserEmployeeViewModel);

        if (!string.IsNullOrEmpty(loginEmployeeRequestViewModel.Token))
        {
         
            await LocalStorageService.SetItemAsync("token", loginEmployeeRequestViewModel.Token);

            await LocalStorageService.SetItemAsync("fullName", loginEmployeeRequestViewModel.FullName);
            await LocalStorageService.SetItemAsync("email", loginEmployeeRequestViewModel.Email);

            // // Show live message
            message = $"Login successful: {loginUserEmployeeViewModel.Username}";

            System.Diagnostics.Debug.WriteLine("Login attempt with: " + JsonSerializer.Serialize(loginUserEmployeeViewModel));
            // Điều hướng
            NavigationManager.NavigateTo("/employees/profile");
        }
        else
        {
            message = "Login failed!";

        }
    }
}