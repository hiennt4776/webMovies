@page "/useremployees/resetpassword/{UserId:int}"
@using BlazorWebAppAdmin.Services
@inject IUserEmployeeService UserEmployeeService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<DashboardHeader Title="Dashboard"
                 BreadcrumbMain="User Employee"
                 BreadcrumbCurrent="Reset Password" />

@if (isLoading)
{
    <p><i class="bi bi-hourglass-split"></i> Loading user information...</p>
}
else if (resetModel == null)
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> User not found.
    </div>
}
else
{
    <div class="card card-outline card-secondary shadow-sm">
        <div class="card-header">
            <h5 class="card-title fw-bold mb-0">
                <i class="bi bi-person-lock me-2"></i> Reset User Password
            </h5>
        </div>

        <div class="card-body">
            <div class="mb-3">
                <h6 class="fw-bold text-secondary">User Information</h6>
                <div class="border rounded p-3 bg-light">
                    <p><strong>Username:</strong> @resetModel.Username</p>
                </div>
            </div>

            <EditForm Model="@resetModel" OnValidSubmit="ResetPasswordAsync">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label class="form-label fw-semibold">New Password</label>
                    <InputText type="password" class="form-control" @bind-Value="resetModel.Password" placeholder="Enter new password" />
                </div>

                <div class="d-flex mt-4">
                    <button type="submit" class="btn btn-primary me-2" disabled="@isProcessing">
                        <i class="bi bi-arrow-repeat me-1"></i>
                        @(isProcessing ? "Resetting..." : "Confirm Reset")
                    </button>

                    <button type="button" class="btn btn-secondary" @onclick="BackToList">
                        <i class="bi bi-arrow-left-circle"></i> Back to List
                    </button>
                </div>
            </EditForm>

            @if (!string.IsNullOrEmpty(message))
            {
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> @message
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public int UserId { get; set; }

    private UserEmployeeResetPasswordViewModel? resetModel;
    private bool isLoading = true;
    private bool isProcessing = false;
    private string message = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        resetModel = await UserEmployeeService.GetResetPasswordInfoAsync(UserId);
        isLoading = false;
    }

    private async Task ResetPasswordAsync()
    {
        if (string.IsNullOrWhiteSpace(resetModel?.Password))
        {
            message = "Please enter a new password before resetting.";
            return;
        }

        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
            $"Are you sure you want to reset the password for '{resetModel?.Username}'?");
        if (!confirmed) return;

        try
        {
            isProcessing = true;
            await UserEmployeeService.UserEmployeeResetPasswordAsync(resetModel!);
            message = $"Password for user '{resetModel?.Username}' has been reset successfully.";
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/userEmployees");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void BackToList() => NavigationManager.NavigateTo("/userEmployees");
}
